name: Sync from Gitee

on:
  schedule:
    - cron: '0 4 * * *'  # UTC 4ç‚¹ = åŒ—äº¬æ—¶é—´12ç‚¹
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨åŒæ­¥åŸå› '
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…³é”®ï¼ç»™å·¥ä½œæµå†™å…¥æƒé™
    
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Gitee Remote
        run: |
          git remote add gitee https://gitee.com/physics_Ag/python-mathematical-modeling.git
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch from Gitee
        run: git fetch gitee

      - name: Merge Changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet master gitee/master; then
            echo "æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹"
            exit 0
          fi
          
          # å°è¯•åˆå¹¶
          git merge --no-commit --no-ff gitee/master || true
          
          # å¤„ç†å†²çª
          if git status --porcelain | grep -q "^UU"; then
            echo "æ£€æµ‹åˆ°å†²çªï¼Œé‡‡ç”¨Giteeç‰ˆæœ¬"
            git diff --name-only --diff-filter=U | while read file; do
              git checkout --theirs "$file"
              git add "$file"
            done
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ”„ Sync from Gitee $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— éœ€æäº¤"

      - name: Push to GitHub
        run: git push origin master
